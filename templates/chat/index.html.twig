{% extends 'base.html.twig' %}

{% block title %}Chat
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<link rel="stylesheet" href="{{ asset('css/chat.css') }}">
{% endblock %}

{# {% block sidebar %}{% endblock %} #}

{% block body %}
	<div id="chat" data-user-id="{{ app.user.id }}">
		<div class="rooms">
			{% for room in rooms %}
				<div class="room-item" data-room-id={{room.id}}>
					{% for utilisateur in room.utilisateurs %}
						{% if utilisateur.id != app.user.id %}
							<div class="room-avatar">
								{% if utilisateur.photo is not null %}
									<img src="{{ vich_uploader_asset(utilisateur, 'photoFile') }}" alt="Photo de profil">
								{% else %}
									<img src="{{ asset('img/defaultProfile.png') }}" alt="Photo de profil">
								{% endif %}
								<a class="room-pseudo" href="{{ path('app_profil', {'id' : utilisateur.id}) }}">
									<p>{{utilisateur.pseudo}}</p>
								</a>
							</div>
						{% endif %}
					{% endfor %}
					<p class="last-message" id="last-message-{{room.id}}">{{ room.lastMessage }}</p>
					<p class="room-date">{{ room.createdAt|format_datetime('short', 'short', locale='fr') }}</p>
				</div>

			{% endfor %}
		</div>
		<div class="message-container">
			<div id="messages"></div>
			<div class="message-form">
				<form class="hide-form" id="send-message-form">
					<textarea type="text" id="message-text" placeholder="Écrivez un message..."></textarea>
					<button class="btn-send" type="submit">
						<span class="material-symbols-outlined">
							send
						</span>
					</button>
				</form>
			</div>
		</div>
	</div>
{% endblock %}


{% block javascripts %}
	{# {{ parent() }} #}
	<script src="{{ asset('js/chat.js') }}"></script>
	<script>
		const eventSource = new EventSource("{{ mercure('localhost:3000/.well-known/mercure?topic=http://exemple.com/rooms/1')|escape('js') }}");
		eventSource.onmessage = event => {
			const data = JSON.parse(event.data);
			console.log(data);
		};

		{# document.addEventListener('DOMContentLoaded', (event) => {
			// Vérifie si selectedRoomId est défini et non null
			{% if selectedRoomId is defined and selectedRoomId is not null %}
				const selectedRoomId = {{ selectedRoomId }};
				// Trouve l'élément DOM correspondant
				const roomElement = document.querySelector(`.room-item[data-room-id="${selectedRoomId}"]`);
				if (roomElement) {
					// Appelle la fonction JavaScript en passant l'élément trouvé
					handleRoomClick.bind(roomElement)();
				}
			{% endif %}
		}); #}
	</script>
{% endblock %}
